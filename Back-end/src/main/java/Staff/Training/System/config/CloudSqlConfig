package staff.training.system.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import javax.sql.DataSource;
import com.zaxxer.hikari.HikariDataSource;

@Configuration
@Profile("cloud")
public class CloudSqlConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        
        // Configure for Cloud SQL
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        dataSource.setJdbcUrl(String.format("jdbc:mysql:///%s", 
                              System.getenv().getOrDefault("DB_NAME", "staff_training_system_database")));
        
        // Configure the socket factory
        dataSource.addDataSourceProperty("socketFactory", "com.google.cloud.sql.mysql.SocketFactory");
        dataSource.addDataSourceProperty("cloudSqlInstance", System.getenv("CLOUD_SQL_CONNECTION_NAME"));
        
        
        // Set database credentials
        dataSource.setUsername(System.getenv().getOrDefault("DB_USER", "root"));
        dataSource.setPassword(System.getenv("DB_PASSWORD"));
        
        return dataSource;
    }
}